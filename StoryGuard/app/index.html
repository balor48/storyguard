<!DOCTYPE html>
<html>
<head>
    <title>Story Database</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A comprehensive database for writers to manage characters, locations, plots, and world-building elements">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Story Database">
    
    <!-- Direct Fix for Table Headers -->
    <style>
        /* Emergency fix for relationship table headers */
        div[role="dialog"] th,
        div[role="dialog"] .character-list table th,
        div[role="dialog"] table th,
        .character-list table th,
        th:contains('First Name'),
        th:contains('Last Name') {
            text-align: center !important;
        }
    </style>
    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/characterdb.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="css/professional-ui.css">
    <link rel="stylesheet" href="css/new-features.css">
    <link rel="stylesheet" href="css/pagination.css">
    <link rel="stylesheet" href="css/button-fix.css">
    <link rel="stylesheet" href="css/book-analysis.css">
    <link rel="stylesheet" href="css/dark-mode-fixes.css">
    <link rel="stylesheet" href="css/dashboard-layout.css">
    <link rel="stylesheet" href="css/stats-fix.css">
    <link rel="stylesheet" href="css/stats-layout.css">
    <link rel="stylesheet" href="css/tag-fix.css">
    <link rel="stylesheet" href="css/relationship-fix.css">
    <link rel="stylesheet" href="css/relationships-new.css">
    <link rel="stylesheet" href="css/tab-font-fix.css">
    <link rel="stylesheet" href="css/tag-cloud-fix.css">
    <link rel="stylesheet" href="css/tag-selector-fix.css">
    <link rel="stylesheet" href="css/validation.css">
    <link rel="stylesheet" href="css/worldbuilding-fix.css">
    <link rel="stylesheet" href="css/world-building.css">
    <link rel="stylesheet" href="css/plot-cards.css">
    <link rel="stylesheet" href="css/timeline-fix.css">
    <link rel="stylesheet" href="css/timeline-filter-fix.css">
    <link rel="stylesheet" href="css/statistics-fix.css">
    <link rel="stylesheet" href="css/checkbox-fix.css">
    <link rel="stylesheet" href="css/relationships-fix.css">
    <link rel="stylesheet" href="css/button-styles.css">
    <link rel="stylesheet" href="css/table-styles.css">
    <link rel="stylesheet" href="css/table-override.css">
    <link rel="stylesheet" href="css/global-table-fix.css">
    <link rel="stylesheet" href="css/table-fix-final.css">
    <link rel="stylesheet" href="css/back-to-top.css">
    <link rel="stylesheet" href="css/rich-text-editor.css">
    <link rel="stylesheet" href="css/database-manager.css">
    <link rel="stylesheet" href="css/world-element-cards-fix.css">
    <link rel="stylesheet" href="css/font-sizes.css">
    <link rel="stylesheet" href="css/character-stats-fix.css">
    <link rel="stylesheet" href="css/relationship-header-fix.css">
    <link rel="stylesheet" href="css/worldbuilding-table-fix.css">
    <link rel="stylesheet" href="css/character-location-table-fix.css">
    <link rel="stylesheet" href="css/plots-table-fix.css">
    <link rel="stylesheet" href="css/pagination-dark-mode-fix.css">
    <link rel="stylesheet" href="css/action-buttons-icon-fix.css">
    <link rel="stylesheet" href="css/relationship-dark-mode-fix.css">
    <link rel="stylesheet" href="css/relationship-network-alignment-fix.css">
    <link rel="stylesheet" href="css/relationship-filter-alignment-fix.css">
    <link rel="stylesheet" href="css/character-table-title-fix.css">
    <link rel="stylesheet" href="css/character-table-column-fix.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Critical JS files loaded first -->
    <script src="js/modules/core.js"></script>
    <script src="js/modules/ui.js"></script>
    
    <!-- Core.showToast fix - prevents null reference errors -->
    <script src="js/core-toast-fix.js"></script>
    
    <!-- Update storage functions to use safer toast methods -->
    <script src="js/storage-function-fix-update.js"></script>
    
    <!-- Logging control - reduces excessive console logs -->
    <script src="js/logging-control.js"></script>
    
    <!-- Database open fix script - fixes Open Database menu item issues -->
    <script src="js/database-open-fix.js"></script>
    
    <!-- Database name fix script - fixes incorrect database name issue -->
    <script src="js/default-database-fix.js"></script>
    
    <!-- Main entry point - controls lazy loading -->
    <script src="js/main.js"></script>
    
    <!-- Backup directory fix - ensures backups go to the correct directory -->
    <script src="js/backup-directory-fix.js"></script>
    
    <!-- Manual backup toast handler - adds toast notifications for manual backups -->
    <script src="js/manual-backup-toast.js"></script>
    
    <!-- Save directory fix - ensures database saves work even without directory configured -->
    <script src="js/save-directory-fix.js"></script>
    
    <!-- Auto-backup fix script -->
    <script src="js/auto-backup-fix-improved.js"></script>
    
    <!-- Settings debug tool - logs auto-backup and other settings information -->
    <script src="js/check-current-settings.js"></script>
    
    <!-- Settings persistence fix - prevents auto-backup settings from being reset -->
    <script src="js/settings-persistence-fix.js"></script>
    
    <!-- Warning suppressor - hides warnings about unconfigured directories -->
    <script src="js/warning-suppressor.js"></script>
    
    <!-- Missing tabs fix - ensures all tab elements exist -->
    <script src="js/missing-tabs-fix.js"></script>
    
    <!-- Tab switching fix - ensures proper tab switching and loading -->
    <script src="js/tab-switching-fix.js"></script>
    
    <!-- Non-critical modules loaded with defer attribute -->
    <script src="js/modules/storage.js" type="module"></script>
    <script src="js/saveSettings-fix.js"></script>
    <script src="js/settings-sync-fix.js"></script>
    <script src="js/loadDatabase-fix.js"></script>
    <script src="js/settings-module-fix.js"></script>
    <script src="js/storage-function-fix.js"></script>
    <script src="js/modules/shortcuts.js" defer></script>
    <script src="js/book-export-controller.js"></script>
    
    <!-- Image handling utilities -->
    <script src="js/images-utils.js"></script>
    
    <!-- Settings menu handler -->
    <script>
        // Initialize settings handler
        document.addEventListener('DOMContentLoaded', () => {
            if (window.api && window.api.onShowSettings) {
                window.api.onShowSettings(() => {
                    // Add a small delay to ensure Storage module is loaded
                    setTimeout(() => {
                        if (window.Storage && typeof window.Storage.showSettingsDialog === 'function') {
                            window.Storage.showSettingsDialog();
                        } else {
                            console.error('Storage.showSettingsDialog not available');
                        }
                    }, 100);
                });
            }
        });
    </script>
    
    <!-- Feature modules loaded on demand -->
    <script src="js/modules/dashboard.js" defer></script>
    <script src="js/modules/dashboard-fix.js" defer></script>
    <script src="js/modules/tags.js" defer></script>
    <script src="js/modules/validation.js" defer></script>
    <script src="js/modules/characters.js" defer></script>
    <script src="js/modules/locations.js" defer></script>
    <script src="js/modules/plots.js" defer></script>
    <script src="js/modules/worldbuilding.js" defer></script>
    <script src="js/modules/relationships.js" defer></script>
    <script src="js/modules/timeline.js" defer></script>
    <script src="js/modules/statistics.js" defer></script>
    <script src="js/modules/book-analysis.js" defer></script>
    <script src="js/modules/name-extractor.js" defer></script>
    <script src="js/modules/book-analysis-integration.js" defer></script>
    <script src="js/modules/name-extractor-integration.js" defer></script>
    <script src="js/modules/database-loader.js" defer></script>
    <script src="js/test-automation-fix.js"></script>
    <script src="js/analyze-book-tab-null-fix.js"></script>
    <script src="js/test-automation.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    
    <!-- Inline script to ensure PDF functions are always available -->
    <script>
        // Make sure we have a global Storage object
        if (!window.Storage) {
            window.Storage = {};
        }
        
        // PDF Export Functions - directly available in global scope
        // Create a PDF with individual views for each item
        window.Storage.createDetailedPDF = function(items, generateItemHTML, filename) {
            console.log(`Creating PDF for ${items.length} items with filename ${filename}`);
            try {
                // Create a container for all items
                const container = document.createElement('div');
                container.style.fontFamily = 'Arial, sans-serif';
                container.style.padding = '20px';
                
                // Add each item to the container
                items.forEach((item) => {
                    const itemContainer = document.createElement('div');
                    itemContainer.style.marginBottom = '30px';
                    itemContainer.style.pageBreakAfter = 'always';
                    itemContainer.innerHTML = generateItemHTML(item);
                    container.appendChild(itemContainer);
                });
                
                // Get PDF directory from settings or use default
                let pdfFolder;
                
                // Try to get the PDF path from settings
                if (window.api && window.api.getPaths) {
                    try {
                        // Use async/await in a self-executing async function
                        (async function() {
                            try {
                                const paths = await window.api.getPaths();
                                pdfFolder = paths.pdf;
                                console.log('Using PDF directory from settings:', pdfFolder);
                            } catch (e) {
                                console.error('Error getting paths from settings:', e);
                                pdfFolder = path.join(__dirname, 'PDF');
                                console.log('Falling back to default PDF directory:', pdfFolder);
                            }
                        })();
                    } catch (e) {
                        console.error('Error in async paths retrieval:', e);
                        pdfFolder = path.join(__dirname, 'PDF');
                        console.log('Falling back to default PDF directory:', pdfFolder);
                    }
                } else {
                    // Fallback to local storage if API is not available
                    pdfFolder = localStorage.getItem('pdfPath') || path.join(__dirname, 'PDF');
                    console.log('Using PDF directory from localStorage:', pdfFolder);
                }
                
                // First ensure the directory exists
                if (window.electron) {
                    window.electron.send('ensure-directory', pdfFolder);
                }
                
                const options = {
                    margin: [10, 10],
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Generate PDF as blob
                html2pdf().from(container).set(options).outputPdf('blob').then(blob => {
                    // Convert blob to base64
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = function() {
                        const base64data = reader.result.split(',')[1];
                        // Send to Electron to save in database folder
                        if (window.electron) {
                            window.electron.send('save-pdf', { 
                                path: `${pdfFolder}\\${filename}`,
                                data: base64data
                            });
                            
                            // Show notification using Core.showToast instead of UI.showNotification
                            if (window.Core && typeof window.Core.showToast === 'function') {
                                window.Core.showToast(`PDF saved to PDF folder: ${filename}`, 'success');
                            } else {
                                console.log(`PDF saved to: ${pdfFolder}\\${filename}`);
                            }
                        } else {
                            // Fallback for non-electron environment
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = filename;
                            link.click();
                            URL.revokeObjectURL(link.href);
                            console.log('PDF downloaded (fallback mode)');
                        }
                    };
                });
                
                console.log('PDF generation started');
                return true;
            } catch (error) {
                console.error('Error creating PDF:', error);
                return false;
            }
        };

        // Export characters to PDF
        window.Storage.exportCharactersToPDF = function() {
            console.log('Exporting characters to PDF...');
            try {
                // Get the current database name for the filename
                const dbName = localStorage.getItem('currentDatabaseName') || 'Default';
                const filename = `Characters_${dbName}.pdf`;
                
                // Generate HTML for a character
                const generateCharacterHTML = (character) => {
                    // Basic character info
                    let html = `
                        <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px;">
                            <h2 style="color: #3498db; margin-top: 0;">${character.firstName || ''} ${character.lastName || ''}</h2>
                            <div style="display: flex; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 300px;">
                                    <h3 style="color: #555;">Personal Information</h3>
                                    <p><strong>Age:</strong> ${character.age || 'N/A'}</p>
                                    <p><strong>Gender:</strong> ${character.gender || 'N/A'}</p>
                                    <p><strong>Occupation:</strong> ${character.occupation || 'N/A'}</p>
                                </div>
                                <div style="flex: 1; min-width: 300px;">
                                    <h3 style="color: #555;">Story Context</h3>
                                    <p><strong>Role:</strong> ${character.role || 'N/A'}</p>
                                    <p><strong>Series:</strong> ${character.series || 'N/A'}</p>
                                    <p><strong>Book:</strong> ${character.book || 'N/A'}</p>
                                </div>
                            </div>
                            <div>
                                <h3 style="color: #555;">Description</h3>
                                <p>${character.description || 'No description available.'}</p>
                            </div>
                            <div>
                                <h3 style="color: #555;">Notes</h3>
                                <p>${character.notes || 'No notes available.'}</p>
                            </div>
                        </div>
                    `;
                    return html;
                };
                
                // Call the createDetailedPDF function
                return window.Storage.createDetailedPDF(window.characters || [], generateCharacterHTML, filename);
            } catch (error) {
                console.error('Error exporting characters to PDF:', error);
                return false;
            }
        };

        // Export locations to PDF
        window.Storage.exportLocationsToPDF = function() {
            console.log('Exporting locations to PDF...');
            try {
                // Get the current database name for the filename
                const dbName = localStorage.getItem('currentDatabaseName') || 'Default';
                const filename = `Locations_${dbName}.pdf`;
                
                // Generate HTML for a location
                const generateLocationHTML = (location) => {
                    // Basic location info
                    let html = `
                        <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px;">
                            <h2 style="color: #3498db; margin-top: 0;">${location.name || 'Unnamed Location'}</h2>
                            <div style="display: flex; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 300px;">
                                    <h3 style="color: #555;">Basic Information</h3>
                                    <p><strong>Type:</strong> ${location.type || 'N/A'}</p>
                                    <p><strong>Region:</strong> ${location.region || 'N/A'}</p>
                                    <p><strong>Country:</strong> ${location.country || 'N/A'}</p>
                                </div>
                                <div style="flex: 1; min-width: 300px;">
                                    <h3 style="color: #555;">Story Context</h3>
                                    <p><strong>Series:</strong> ${location.series || 'N/A'}</p>
                                    <p><strong>Book:</strong> ${location.book || 'N/A'}</p>
                                </div>
                            </div>
                            <div>
                                <h3 style="color: #555;">Description</h3>
                                <p>${location.description || 'No description available.'}</p>
                            </div>
                            <div>
                                <h3 style="color: #555;">Notes</h3>
                                <p>${location.notes || 'No notes available.'}</p>
                            </div>
                        </div>
                    `;
                    return html;
                };
                
                // Call the createDetailedPDF function
                return window.Storage.createDetailedPDF(window.locations || [], generateLocationHTML, filename);
            } catch (error) {
                console.error('Error exporting locations to PDF:', error);
                return false;
            }
        };

        // Export plots to PDF
        window.Storage.exportPlotsToPDF = function() {
            console.log('Exporting plots to PDF...');
            try {
                // Get the current database name for the filename
                const dbName = localStorage.getItem('currentDatabaseName') || 'Default';
                const filename = `Plots_${dbName}.pdf`;
                
                // Generate HTML for a plot
                const generatePlotHTML = (plot) => {
                    // Basic plot info
                    let html = `
                        <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px;">
                            <h2 style="color: #3498db; margin-top: 0;">${plot.title || 'Unnamed Plot'}</h2>
                            <div style="display: flex; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 300px;">
                                    <h3 style="color: #555;">Basic Information</h3>
                                    <p><strong>Type:</strong> ${plot.type || 'N/A'}</p>
                                    <p><strong>Status:</strong> ${plot.status || 'N/A'}</p>
                                </div>
                                <div style="flex: 1; min-width: 300px;">
                                    <h3 style="color: #555;">Story Context</h3>
                                    <p><strong>Series:</strong> ${plot.series || 'N/A'}</p>
                                    <p><strong>Book:</strong> ${plot.book || 'N/A'}</p>
                                </div>
                            </div>
                            <div>
                                <h3 style="color: #555;">Description</h3>
                                <p>${plot.description || 'No description available.'}</p>
                            </div>
                            <div>
                                <h3 style="color: #555;">Notes</h3>
                                <p>${plot.notes || 'No notes available.'}</p>
                            </div>
                        </div>
                    `;
                    return html;
                };
                
                // Call the createDetailedPDF function
                return window.Storage.createDetailedPDF(window.plots || [], generatePlotHTML, filename);
            } catch (error) {
                console.error('Error exporting plots to PDF:', error);
                return false;
            }
        };

        // Export world-building to PDF
        window.Storage.exportWorldBuildingToPDF = function() {
            console.log('Exporting world-building to PDF...');
            try {
                // Get the current database name for the filename
                const dbName = localStorage.getItem('currentDatabaseName') || 'Default';
                const filename = `WorldBuilding_${dbName}.pdf`;
                
                // Generate HTML for a world element
                const generateWorldElementHTML = (element) => {
                    // Basic world element info
                    let html = `
                        <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px;">
                            <h2 style="color: #3498db; margin-top: 0;">${element.name || 'Unnamed Element'}</h2>
                            <div style="display: flex; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 300px;">
                                    <h3 style="color: #555;">Basic Information</h3>
                                    <p><strong>Category:</strong> ${element.category || 'N/A'}</p>
                                    <p><strong>Type:</strong> ${element.type || 'N/A'}</p>
                                </div>
                                <div style="flex: 1; min-width: 300px;">
                                    <h3 style="color: #555;">Story Context</h3>
                                    <p><strong>Series:</strong> ${element.series || 'N/A'}</p>
                                    <p><strong>Book:</strong> ${element.book || 'N/A'}</p>
                                </div>
                            </div>
                            <div>
                                <h3 style="color: #555;">Description</h3>
                                <p>${element.description || 'No description available.'}</p>
                            </div>
                            <div>
                                <h3 style="color: #555;">Notes</h3>
                                <p>${element.notes || 'No notes available.'}</p>
                            </div>
                        </div>
                    `;
                    return html;
                };
                
                // Call the createDetailedPDF function
                return window.Storage.createDetailedPDF(window.worldElements || [], generateWorldElementHTML, filename);
            } catch (error) {
                console.error('Error exporting world-building to PDF:', error);
                return false;
            }
        };
        
        // Log that the PDF functions are available
        console.log('PDF functions initialized directly in the HTML');
    </script>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Theme styles */
        body.theme-light {
            background-color: #f5f5f5;
            color: #000000;
        }
        
        body.theme-dark {
            background-color: #1e1e1e;
            color: #ffffff;
        }
        
        /* Theme-specific table styles */
        body.theme-dark table {
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        body.theme-dark th {
            background-color: #3d3d3d;
        }
        
        body.theme-dark tr:nth-child(even) {
            background-color: #363636;
        }
        
        body.theme-dark tr:hover {
            background-color: #404040;
        }
    </style>
</head>
<body>
    <div id="loadingIndicator" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; font-size: 24px;">
        <div style="background-color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);">
            <div style="display: flex; align-items: center;">
                <div class="loading-spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; margin-right: 15px; animation: spin 2s linear infinite;"></div>
                <div>Loading...</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div style="position: relative;">
            <h1>Story Database</h1>
            
            <!-- Current Database Indicator -->
            <div class="database-indicator" style="position: absolute; top: 5px; left: 0; background-color: rgba(52, 152, 219, 0.9); color: white; padding: 7px 12px; border-radius: 5px; font-size: 14px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-database" style="font-size: 14px;"></i>
                    <span>Database: <span id="currentDatabaseName">Default</span></span>
                    <button id="saveDatabase" onclick="Storage.saveDatabase()" style="background-color: #e67e22; color: white; border: none; border-radius: 3px; padding: 3px 8px; font-size: 12px; cursor: pointer; margin-left: 5px;"><i class="fas fa-save"></i> Save</button>
                    <button id="manageDatabase" onclick="Storage.showDatabaseManager()" style="background-color: #2ecc71; color: white; border: none; border-radius: 3px; padding: 3px 8px; font-size: 12px; cursor: pointer;"><i class="fas fa-cog"></i> Manage</button>
                </div>
            </div>
            
            <!-- Offline Features Info removed as it's not needed for desktop application -->
        </div>
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="UI.switchTab('dashboard')">Dashboard</button>
            <button class="tab-button" onclick="UI.switchTab('characters')">Characters</button>
            <button class="tab-button" onclick="UI.switchTab('locations')">Locations</button>
            <button class="tab-button" onclick="UI.switchTab('relationships')">Relationships</button>
            <button class="tab-button" onclick="UI.switchTab('plots')">Plots</button>
            <button class="tab-button" onclick="UI.switchTab('worldbuilding')">World-Building</button>
            <button class="tab-button" onclick="UI.switchTab('timeline')">Timeline</button>
            <button class="tab-button" onclick="UI.switchTab('statistics')">Statistics</button>
            <button class="tab-button" id="analyze-book-tab-button" onclick="UI.switchTab('analyze-book');">Analyze Book</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <!-- Content will be dynamically generated by Dashboard.displayDashboard() -->
        </div>
        
        <!-- Characters Tab -->
        <div id="characters-tab" class="tab-content">
            <h2 style="font-weight: bold; position: relative; top: 6px; margin-bottom: 0.25rem;">Character Database</h2>
            <div class="file-controls" style="width: auto !important; display: flex !important; position: absolute; top: 10px; right: 20px;">
                <button onclick="Storage.exportCharactersToPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                <button onclick="Storage.exportCharactersToHTML()"><i class="fas fa-file-code"></i> HTML</button>
                <button onclick="Storage.exportCharactersToTXT()"><i class="fas fa-file-alt"></i> TXT</button>
            </div>

            <!-- Search -->
            <div class="search-container" style="margin-top: -20px;">
                <div class="search-basic">
                    <select id="searchField">
                        <option value="all">All Fields</option>
                        <option value="firstName">First Name</option>
                        <option value="lastName">Last Name</option>
                        <option value="title">Title</option>
                        <option value="series">Series</option>
                        <option value="book">Book</option>
                        <option value="race">Race</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="Search characters...">
                    <button type="button" class="search-button"><i class="fas fa-search"></i></button>
                </div>
                <div class="advanced-search-toggle" onclick="UI.toggleAdvancedSearch()">Advanced Search ▼</div>
                <div id="advancedSearch" class="advanced-search" style="display: none;">
                    <div class="input-group">
                        <label for="filterSeries">Series</label>
                        <select id="filterSeries">
                            <option value="">Any Series</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="filterBook">Book</label>
                        <select id="filterBook">
                            <option value="">Any Book</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="filterRole">Role</label>
                        <select id="filterRole">
                            <option value="">Any Role</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="filterRace">Race</label>
                        <select id="filterRace">
                            <option value="">Any Race</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Tag Cloud -->
            <div id="characterTagCloud"></div>
            
            <!-- Character Form -->
            <form id="characterForm" novalidate>
                <div class="form-grid">
                    <!-- Personal Info Group -->
                    <div class="form-group">
                        <h3><i class="fas fa-user-circle"></i> Personal Information</h3>
                        
                        <div class="input-group">
                            <label for="title">Title</label>
                            <select id="title" name="title" onchange="Characters.handleDropdownChange('title', this.value)">
                                <option value="">Select Title</option>
                                <option value="new">+ Add New Title</option>
                            </select>
                            <div id="newTitleForm" class="new-item-form">
                                <input type="text" id="newTitleInput" placeholder="Enter new title">
                                <div class="form-buttons-row">
                                    <button type="button" onclick="Characters.addNewItem('title')">Add Title</button>
                                    <button type="button" onclick="Characters.cancelNewItem('title')" class="cancel-btn">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="firstName">First Name*</label>
                            <div class="name-input-container">
                                <input type="text" id="firstName" name="firstName" placeholder="Enter first name" list="firstNameSuggestions" autocomplete="off">
                                <datalist id="firstNameSuggestions"></datalist>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="lastName">Last Name</label>
                            <input type="text" id="lastName" name="lastName" placeholder="Enter last name">
                        </div>
                        
                        <!-- Name Generator -->
                        <div class="input-group name-generator">
                            <label>Name Generator</label>
                            <div class="name-generator-controls">
                                <select id="nameGeneratorRace">
                                    <option value="human">Human</option>
                                    <option value="elf">Elf</option>
                                    <option value="dwarf">Dwarf</option>
                                    <option value="orc">Orc</option>
                                    <option value="halfling">Halfling</option>
                                    <option value="gnome">Gnome</option>
                                    <option value="dragonborn">Dragonborn</option>
                                    <option value="tiefling">Tiefling</option>
                                </select>
                                <button type="button" class="generate-name-btn" style="width: 180px !important; font-size: 14px !important;" onclick="Characters.generateRandomName()">Generate Name</button>
                            </div>
                            <div id="generatedNameResult" class="generated-name-result" style="display: none;">
                                <div class="generated-name-display">
                                    <span id="generatedFirstName"></span> <span id="generatedLastName"></span>
                                </div>
                                <div class="generated-name-actions">
                                    <button type="button" onclick="Characters.acceptGeneratedName()">Use This Name</button>
                                    <button type="button" onclick="Characters.generateRandomName()">Try Again</button>
                                </div>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="sex">Sex</label>
                            <input type="text" id="sex" name="sex" placeholder="Enter sex">
                        </div>

                        <div class="input-group">
                            <label for="race">Race</label>
                            <input type="text" id="race" name="race" placeholder="Enter race">
                        </div>
                    </div>

                    <!-- Story Information Group -->
                    <div class="form-group">
                        <h3><i class="fas fa-book"></i> Story Information</h3>
                        <div class="input-group">
                            <label for="role">Role</label>
                            <select id="role" name="role" onchange="Characters.handleDropdownChange('role', this.value)">
                                <option value="">Select Role</option>
                                <option value="new">+ Add New Role</option>
                            </select>
                            <div id="newRoleForm" class="new-item-form">
                                <input type="text" id="newRoleInput" placeholder="Enter new role">
                                <div class="form-buttons-row">
                                    <button type="button" onclick="Characters.addNewItem('role')">Add Role</button>
                                    <button type="button" onclick="Characters.cancelNewItem('role')" class="cancel-btn">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="series">Series</label>
                            <select id="series" name="series" onchange="Characters.handleDropdownChange('series', this.value)">
                                <option value="">Select Series</option>
                                <option value="new">+ Add New Series</option>
                            </select>
                            <div id="newSeriesForm" class="new-item-form">
                                <input type="text" id="newSeriesInput" placeholder="Enter new series">
                                <div class="form-buttons-row">
                                    <button type="button" onclick="Characters.addNewItem('series')">Add Series</button>
                                    <button type="button" onclick="Characters.cancelNewItem('series')" class="cancel-btn">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="book">Book</label>
                            <select id="book" name="book" onchange="Characters.handleDropdownChange('book', this.value)">
                                <option value="">Select Book</option>
                                <option value="new">+ Add New Book</option>
                            </select>
                            <div id="newBookForm" class="new-item-form">
                                <input type="text" id="newBookInput" placeholder="Enter new book">
                                <div class="form-buttons-row">
                                    <button type="button" onclick="Characters.addNewItem('book')">Add Book</button>
                                    <button type="button" onclick="Characters.cancelNewItem('book')" class="cancel-btn">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tags -->
                        <div class="input-group">
                            <label>Tags</label>
                            <div id="characterTagSelector" class="tag-selector" data-entity-type="character" data-entity-id="">
                                <!-- Tag selector will be populated by Tags.createTagSelector() -->
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details Group -->
                    <div class="form-group">
                        <h3><i class="fas fa-info-circle"></i> Additional Details</h3>
                        <div id="customFieldsContainer">
                            <!-- Dynamic custom fields will be added here -->
                        </div>
                        <button type="button" class="add-field-btn" onclick="Characters.addCustomField()">
                            <i class="fas fa-plus-circle"></i> Add Custom Field
                        </button>

                        <div class="input-group">
                            <label for="notes">Notes</label>
                            <!-- Rich Text Editor Toolbar -->
                            <div class="rich-text-toolbar">
                                <button type="button" class="rich-text-btn" data-command="bold" title="Bold">B</button>
                                <button type="button" class="rich-text-btn" data-command="italic" title="Italic">I</button>
                                <button type="button" class="rich-text-btn" data-command="underline" title="Underline">U</button>
                                <button type="button" class="rich-text-btn" data-command="insertUnorderedList" title="Bullet List">• List</button>
                                <button type="button" class="rich-text-btn" data-command="insertOrderedList" title="Numbered List">1. List</button>
                            </div>
                            <div id="richTextEditor" class="rich-text-editor" contenteditable="true"></div>
                            <textarea id="notes" name="notes" style="display: none;"></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="submit" class="add-character-btn"><i class="fas fa-user-plus"></i> Add</button>
                    <button type="button" class="clear-form-btn" onclick="Characters.clearForm()"><i class="fas fa-eraser"></i> Clear</button>
                    
                    <!-- Statistics Section moved to the right of the Clear button -->
                    <div class="statistics">
                        <div class="statistics-grid">
                            <div class="stat-card">
                                <i class="fas fa-users stat-icon"></i>
                                <h4>Total Characters</h4>
                                <p id="totalCharacters">0</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-book-open stat-icon"></i>
                                <h4>Total Series</h4>
                                <p id="totalSeries">0</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-book-open stat-icon"></i>
                                <h4>Total Books</h4>
                                <p id="totalBooks">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Character Table -->
            <div class="table-container">
                <table id="characterTable">
                    <thead>
                        <tr>
                            <th onclick="Characters.sortTable('title')" class="sortable">Title</th>
                            <th onclick="Characters.sortTable('firstName')" class="sortable">First</th>
                            <th onclick="Characters.sortTable('lastName')" class="sortable">Last</th>
                            <th onclick="Characters.sortTable('race')" class="sortable">Race</th>
                            <th onclick="Characters.sortTable('series')" class="sortable">Series</th>
                            <th onclick="Characters.sortTable('book')" class="sortable">Book</th>
                            <th onclick="Characters.sortTable('role')" class="sortable">Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="characterList"></tbody>
                </table>
                <div id="characterPagination" class="pagination-controls"></div>
            </div>
        </div> <!-- End of characters-tab -->
        
        <!-- Locations Tab -->
        <div id="locations-tab" class="tab-content">
            <h2 style="font-weight: bold; position: relative; top: 6px; margin-bottom: 0.25rem;">Location Database</h2>
            <div class="file-controls" style="width: auto !important; display: flex !important; position: absolute; top: 10px; right: 20px;">
                <button onclick="Storage.exportLocationsToPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                <button onclick="Storage.exportLocationsToHTML()"><i class="fas fa-file-code"></i> HTML</button>
                <button onclick="Storage.exportLocationsToTXT()"><i class="fas fa-file-alt"></i> TXT</button>
            </div>
            
            <!-- Search -->
            <div class="search-container" style="margin-top: -20px;">
                <div class="search-basic">
                    <select id="locationSearchField">
                        <option value="all">All Fields</option>
                        <option value="name">Name</option>
                        <option value="type">Type</option>
                        <option value="series">Series</option>
                        <option value="book">Book</option>
                    </select>
                    <input type="text" id="locationSearchInput" placeholder="Search locations...">
                    <button type="button" class="search-button"><i class="fas fa-search"></i></button>
                </div>
                <div class="advanced-search-toggle" onclick="UI.toggleLocationAdvancedSearch()">Advanced Search ▼</div>
                <div id="locationAdvancedSearch" class="advanced-search" style="display: none;">
                    <div class="input-group">
                        <label for="filterLocationSeries">Series</label>
                        <select id="filterLocationSeries">
                            <option value="">Any Series</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="filterLocationType">Type</label>
                        <select id="filterLocationType">
                            <option value="">Any Type</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Tag Cloud -->
            <div id="locationTagCloud"></div>
            
            <!-- Location Form -->
            <form id="locationForm" novalidate>
                <div class="form-grid">
                    <!-- Basic Info Group -->
                    <div class="form-group">
                        <h3>Basic Information</h3>
                        
                        <div class="input-group">
                            <label for="locationName">Name*</label>
                            <input type="text" id="locationName" name="locationName" placeholder="Enter location name">
                        </div>
                        
                        <!-- Location Name Generator -->
                        <div class="input-group name-generator">
                            <label>Name Generator</label>
                            <div class="name-generator-controls">
                                <select id="locationGeneratorType">
                                    <option value="city">City</option>
                                    <option value="town">Town</option>
                                    <option value="village">Village</option>
                                    <option value="castle">Castle</option>
                                    <option value="forest">Forest</option>
                                    <option value="mountain">Mountain</option>
                                    <option value="kingdom">Kingdom</option>
                                    <option value="realm">Realm</option>
                                </select>
                                <button type="button" class="generate-name-btn" style="width: 180px !important; font-size: 14px !important;" onclick="Locations.generateRandomLocationName()">Generate Name</button>
                            </div>
                            <div id="generatedLocationNameResult" class="generated-name-result" style="display: none;">
                                <div class="generated-name-display">
                                    <span id="generatedLocationName"></span>
                                </div>
                                <div class="generated-name-actions">
                                    <button type="button" onclick="Locations.acceptGeneratedLocationName()">Use This Name</button>
                                    <button type="button" onclick="Locations.generateRandomLocationName()">Try Again</button>
                                </div>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="locationType">Type</label>
                            <select id="locationType" name="locationType" onchange="Locations.handleDropdownChange('locationType', this.value)">
                                <option value="">Select Type</option>
                                <option value="new">+ Add New Type</option>
                            </select>
                            <div id="newLocationTypeForm" class="new-item-form">
                                <input type="text" id="newLocationTypeInput" placeholder="Enter new type">
                                <div class="form-buttons-row">
                                    <button type="button" onclick="Locations.addNewItem('locationType')">Add Type</button>
                                    <button type="button" onclick="Locations.cancelNewItem('locationType')" class="cancel-btn">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="locationSize">Size/Scale</label>
                            <input type="text" id="locationSize" name="locationSize" placeholder="Enter size or scale">
                        </div>
                    </div>

                    <!-- Story Context -->
                    <div class="form-group">
                        <h3>Story Context</h3>
                        <div class="input-group">
                            <label for="locationSeries">Series</label>
                            <select id="locationSeries" name="locationSeries" onchange="Locations.handleDropdownChange('locationSeries', this.value)">
                                <option value="">Select Series</option>
                                <option value="new">+ Add New Series</option>
                            </select>
                            <div id="newLocationSeriesForm" class="new-item-form">
                                <input type="text" id="newLocationSeriesInput" placeholder="Enter new series">
                                <div class="form-buttons-row">
                                    <button type="button" onclick="Locations.addNewItem('locationSeries')">Add Series</button>
                                    <button type="button" onclick="Locations.cancelNewItem('locationSeries')" class="cancel-btn">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="locationBook">Book</label>
                            <select id="locationBook" name="locationBook" onchange="Locations.handleDropdownChange('locationBook', this.value)">
                                <option value="">Select Book</option>
                                <option value="new">+ Add New Book</option>
                            </select>
                            <div id="newLocationBookForm" class="new-item-form">
                                <input type="text" id="newLocationBookInput" placeholder="Enter new book">
                                <div class="form-buttons-row">
                                    <button type="button" onclick="Locations.addNewItem('locationBook')">Add Book</button>
                                    <button type="button" onclick="Locations.cancelNewItem('locationBook')" class="cancel-btn">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tags -->
                        <div class="input-group">
                            <label>Tags</label>
                            <div id="locationTagSelector" class="tag-selector" data-entity-type="location" data-entity-id="">
                                <!-- Tag selector will be populated by Tags.createTagSelector() -->
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="locationDescription">Description</label>
                            <!-- Rich Text Editor Toolbar -->
                            <div class="rich-text-toolbar">
                                <button type="button" class="rich-text-btn" data-command="bold" title="Bold">B</button>
                                <button type="button" class="rich-text-btn" data-command="italic" title="Italic">I</button>
                                <button type="button" class="rich-text-btn" data-command="underline" title="Underline">U</button>
                                <button type="button" class="rich-text-btn" data-command="insertUnorderedList" title="Bullet List">• List</button>
                                <button type="button" class="rich-text-btn" data-command="insertOrderedList" title="Numbered List">1. List</button>
                            </div>
                            <div id="locationRichTextEditor" class="rich-text-editor" contenteditable="true"></div>
                            <textarea id="locationDescription" name="locationDescription" style="display: none;"></textarea>
                        </div>
                    </div>

                    <!-- Additional Details -->
                    <div class="form-group">
                        <h3>Additional Details</h3>
                        <div class="input-group">
                            <label for="locationClimate">Climate/Environment</label>
                            <input type="text" id="locationClimate" name="locationClimate" placeholder="Enter climate or environment">
                        </div>

                        <div class="input-group">
                            <label for="locationPopulation">Population/Inhabitants</label>
                            <input type="text" id="locationPopulation" name="locationPopulation" placeholder="Enter population or inhabitants">
                        </div>

                        <div class="input-group">
                            <label for="locationNotes">Notes</label>
                            <textarea id="locationNotes" name="locationNotes" placeholder="Enter additional notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="submit" class="add-location-btn"><i class="fas fa-map-marker-alt"></i> Add</button>
                    <button type="button" class="clear-form-btn" onclick="Locations.clearLocationForm()"><i class="fas fa-eraser"></i> Clear</button>
                </div>
            </form>

            <!-- Location Table -->
            <div class="table-container">
                <table id="locationTable">
                    <thead>
                        <tr>
                            <th onclick="Locations.sortLocationTable('name')" class="sortable">Name</th>
                            <th onclick="Locations.sortLocationTable('type')" class="sortable">Type</th>
                            <th onclick="Locations.sortLocationTable('size')" class="sortable">Size/Scale</th>
                            <th onclick="Locations.sortLocationTable('series')" class="sortable">Series</th>
                            <th onclick="Locations.sortLocationTable('book')" class="sortable">Book</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="locationList"></tbody>
                </table>
                <div id="locationPagination" class="pagination-controls"></div>
            </div>
        </div>
        
        <!-- Relationships Tab -->
        <div id="relationships-tab" class="tab-content">
            <h2>Character Relationships</h2>
            
            <!-- Relationship Filter Section -->
            <div class="search-container">
                <select id="relationshipFilterType">
                    <option value="all">All Relationship Types</option>
                    <option value="friend">Friends</option>
                    <option value="family">Family</option>
                    <option value="ally">Allies</option>
                    <option value="enemy">Enemies</option>
                    <option value="mentor">Mentors</option>
                    <option value="student">Students</option>
                    <option value="lover">Lovers</option>
                    <option value="rival">Rivals</option>
                    <option value="other">Other</option>
                </select>
                <select id="relationshipFilterCharacter">
                    <option value="all">All Characters</option>
                </select>
                <div class="relationship-filter-buttons">
                    <button type="button" class="apply-filter-btn" onclick="Relationships.applyFilters()">
                        <i class="fas fa-filter"></i> Apply
                    </button>
                    <button type="button" class="clear-filter-btn" onclick="Relationships.clearFilters()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
            
            <!-- Relationship Display Section -->
            <div id="relationshipNetwork"></div>
            <div id="relationshipList"></div>
            
            <!-- Create New Relationships Section - Wrapped in a container for better control -->
            <div class="relationship-creation-wrapper">
                <div class="header">Create New Relationship</div>
                
                <div class="relationship-content">
                    <div class="character-selection">
                        <!-- Character 1 -->
                        <div class="character-column">
                            <h4>Character 1</h4>
                            <input type="text" class="character-search">
                            <div class="character-list">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>First Name</th>
                                            <th>Last Name</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Relationship Type -->
                        <div class="relationship-type">
                            <h4>Relationship</h4>
                            <div class="relationship-options">
                                <div class="relationship-option" data-type="friend">Friend</div>
                                <div class="relationship-option" data-type="family">Family</div>
                                <div class="relationship-option" data-type="ally">Ally</div>
                                <div class="relationship-option" data-type="enemy">Enemy</div>
                                <div class="relationship-option" data-type="mentor">Mentor</div>
                                <div class="relationship-option" data-type="student">Student</div>
                                <div class="relationship-option" data-type="lover">Lover</div>
                                <div class="relationship-option" data-type="rival">Rival</div>
                                <div class="relationship-option" data-type="other">Other</div>
                            </div>
                        </div>
                        
                        <!-- Character 2 -->
                        <div class="character-column">
                            <h4>Character 2</h4>
                            <input type="text" class="character-search">
                            <div class="character-list">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>First Name</th>
                                            <th>Last Name</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="relationship-action-buttons">
                        <div id="relationshipFeedback" class="feedback-message"></div>
                        <button id="addRelationshipBtn" class="add-relationship-btn" disabled onclick="Relationships.createNewRelationship()">Add Relationship</button>
                        <button id="clearRelationshipBtn" class="clear-btn" onclick="Relationships.clearSelections()">Clear</button>
                        <div id="relationshipStatusText" style="color: #e74c3c; text-align: center; margin-top: 10px; font-weight: bold;">Create a Relationship</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Plots Tab -->
        <div id="plots-tab" class="tab-content">
            <h2 style="font-weight: bold; position: relative; top: 6px; margin-bottom: 0.25rem;">Plot Database</h2>
            <div class="file-controls" style="width: auto !important; display: flex !important; position: absolute; top: 10px; right: 20px;">
                <button onclick="Storage.exportPlotsToPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                <button onclick="Storage.exportPlotsToHTML()"><i class="fas fa-file-code"></i> HTML</button>
                <button onclick="Storage.exportPlotsToTXT()"><i class="fas fa-file-alt"></i> TXT</button>
            </div>
            
            <!-- Search -->
            <div class="search-container" style="margin-top: -20px;">
                <div class="search-basic">
                    <select id="plotSearchField">
                        <option value="all">All Fields</option>
                        <option value="title">Title</option>
                        <option value="type">Type</option>
                        <option value="series">Series</option>
                        <option value="book">Book</option>
                    </select>
                    <input type="text" id="plotSearchInput" placeholder="Search plots...">
                    <button type="button" class="search-button"><i class="fas fa-search"></i></button>
                </div>
                <div class="advanced-search-toggle" onclick="document.getElementById('plotAdvancedSearch').style.display = document.getElementById('plotAdvancedSearch').style.display === 'none' ? 'grid' : 'none'">Advanced Search ▼</div>
                <div id="plotAdvancedSearch" class="advanced-search" style="display: none;">
                    <div class="input-group">
                        <label for="filterPlotSeries">Series</label>
                        <select id="filterPlotSeries">
                            <option value="">Any Series</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="filterPlotBook">Book</label>
                        <select id="filterPlotBook">
                            <option value="">Any Book</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="filterPlotType">Type</label>
                        <select id="filterPlotType">
                            <option value="">Any Type</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="filterPlotStatus">Status</label>
                        <select id="filterPlotStatus">
                            <option value="">Any Status</option>
                            <option value="Planned">Planned</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Revised">Revised</option>
                            <option value="Cut">Cut</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Tag Cloud -->
            <div id="plotTagCloud"></div>
            
            <h2 class="section-title">Plot Arc Visualization</h2>
            
            <!-- Plot Arc Visualization -->
            <div id="plotArcVisualization">
                <!-- This content will be generated dynamically by the updatePlotArcVisualization function -->
            </div>
            
            <!-- Plot Form -->
            <form id="plotForm" novalidate>
                <div class="form-grid">
                    <!-- Basic Info Group -->
                    <div class="form-group">
                        <h3>Basic Information</h3>
                        
                        <div class="input-group">
                            <label for="plotTitle">Title*</label>
                            <input type="text" id="plotTitle" name="plotTitle" placeholder="Enter plot title">
                        </div>
                        
                        <div class="input-group">
                            <label for="plotType">Type</label>
                            <select id="plotType" name="plotType" onchange="Plots.handleDropdownChange('plotType', this.value)">
                                <option value="">Select Type</option>
                                <option value="new">+ Add New Type</option>
                                <!-- Options will be populated by Plots.initializePlotForm() -->
                            </select>
                            <div id="newPlotTypeForm" class="new-item-form">
                                <input type="text" id="newPlotTypeInput" placeholder="Enter new plot type">
                                <div class="form-buttons-row">
                                    <button type="button" onclick="Plots.addNewItem('plotType')">Add Type</button>
                                    <button type="button" onclick="Plots.cancelNewItem('plotType')" class="cancel-btn">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="plotStatus">Status</label>
                            <select id="plotStatus" name="plotStatus">
                                <option value="">Select Status</option>
                                <!-- Options will be populated by Plots.initializePlotForm() -->
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="plotOrder">Order/Sequence</label>
                            <input type="number" id="plotOrder" name="plotOrder" placeholder="Enter sequence number (optional)">
                        </div>
                    </div>
                    
                    <!-- Story Context -->
                    <div class="form-group">
                        <h3>Story Context</h3>
                        
                        <div class="input-group">
                            <label for="plotSeries">Series</label>
                            <select id="plotSeries" name="plotSeries">
                                <option value="">Select Series</option>
                                <!-- Options will be populated by Plots.initializePlotForm() -->
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="plotBook">Book</label>
                            <select id="plotBook" name="plotBook">
                                <option value="">Select Book</option>
                                <!-- Options will be populated by Plots.initializePlotForm() -->
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="plotChapter">Chapter</label>
                            <input type="text" id="plotChapter" name="plotChapter" placeholder="Enter chapter (optional)">
                        </div>
                        
                        <!-- Tags -->
                        <div class="input-group">
                            <label>Tags</label>
                            <div id="plotTagSelector" class="tag-selector" data-entity-type="plot" data-entity-id="">
                                <!-- Tag selector will be populated by Tags.createTagSelector() -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Related Elements -->
                    <div class="form-group">
                        <h3>Related Elements</h3>
                        
                        <div class="input-group">
                            <label for="plotCharacters">Characters</label>
                            <select id="plotCharacters" name="plotCharacters" multiple size="5">
                                <!-- Options will be populated by Plots.initializePlotForm() -->
                            </select>
                            <small>Hold Ctrl/Cmd to select multiple</small>
                        </div>
                        
                        <div class="input-group">
                            <label for="plotLocations">Locations</label>
                            <select id="plotLocations" name="plotLocations" multiple size="5">
                                <!-- Options will be populated by Plots.initializePlotForm() -->
                            </select>
                            <small>Hold Ctrl/Cmd to select multiple</small>
                        </div>
                        
                        <div class="input-group">
                            <label for="plotDescription">Description</label>
                            <!-- Rich Text Editor Toolbar -->
                            <div class="rich-text-toolbar">
                                <button type="button" class="rich-text-btn" data-command="bold" title="Bold">B</button>
                                <button type="button" class="rich-text-btn" data-command="italic" title="Italic">I</button>
                                <button type="button" class="rich-text-btn" data-command="underline" title="Underline">U</button>
                                <button type="button" class="rich-text-btn" data-command="insertUnorderedList" title="Bullet List">• List</button>
                                <button type="button" class="rich-text-btn" data-command="insertOrderedList" title="Numbered List">1. List</button>
                            </div>
                            <div id="plotRichTextEditor" class="rich-text-editor" contenteditable="true"></div>
                            <textarea id="plotDescription" name="plotDescription" style="display: none;"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="add-plot-btn"><i class="fas fa-plus-circle"></i> Add</button>
                    <button type="button" class="clear-form-btn" onclick="Plots.clearPlotForm()"><i class="fas fa-eraser"></i> Clear</button>
                </div>
            </form>
            
            <!-- Plot Table -->
            <div class="table-container">
                <table id="plotTable">
                    <thead>
                        <tr>
                            <th onclick="Plots.sortPlotTable('title')" class="sortable">Title</th>
                            <th onclick="Plots.sortPlotTable('type')" class="sortable">Type</th>
                            <th onclick="Plots.sortPlotTable('series')" class="sortable">Series</th>
                            <th onclick="Plots.sortPlotTable('book')" class="sortable">Book</th>
                            <th onclick="Plots.sortPlotTable('chapter')" class="sortable">Chapter</th>
                            <th onclick="Plots.sortPlotTable('status')" class="sortable">Status</th>
                            <th onclick="Plots.sortPlotTable('description')" class="sortable">Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="plotList"></tbody>
                </table>
                <div id="plotPagination" class="pagination-controls"></div>
            </div>
        </div>
        
        <!-- Worldbuilding Tab -->
        <div id="worldbuilding-tab" class="tab-content">
            <h2 style="font-weight: bold; position: relative; top: 6px; margin-bottom: 0.25rem;">Worldbuilding Elements</h2>
            <div class="file-controls" style="width: auto !important; display: flex !important; position: absolute; top: 10px; right: 20px;">
                <button onclick="Storage.exportWorldBuildingToPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                <button onclick="Storage.exportWorldBuildingToHTML()"><i class="fas fa-file-code"></i> HTML</button>
                <button onclick="Storage.exportWorldBuildingToTXT()"><i class="fas fa-file-alt"></i> TXT</button>
            </div>
            
            <!-- Search -->
            <div class="search-container" style="margin-top: -20px;">
                <div class="search-basic">
                    <select id="worldSearchField">
                        <option value="all">All Fields</option>
                        <option value="name">Name</option>
                        <option value="category">Category</option>
                        <option value="series">Series</option>
                    </select>
                    <input type="text" id="worldSearchInput" placeholder="Search world elements...">
                    <button type="button" class="search-button"><i class="fas fa-search"></i></button>
                </div>
                <div class="advanced-search-toggle" onclick="document.getElementById('worldAdvancedSearch').style.display = document.getElementById('worldAdvancedSearch').style.display === 'none' ? 'grid' : 'none'">Advanced Search ▼</div>
                <div id="worldAdvancedSearch" class="advanced-search" style="display: none;">
                    <div class="input-group">
                        <label for="filterWorldSeries">Series</label>
                        <select id="filterWorldSeries">
                            <option value="">Any Series</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="filterWorldCategory">Category</label>
                        <select id="filterWorldCategory">
                            <option value="">Any Category</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Tag Cloud -->
            <div id="worldTagCloud" class="tag-cloud-container"></div>
            
            <!-- World-Building Visualization -->
            <div id="worldBuildingVisualization"></div>
            
            <!-- World Element Form -->
            <form id="worldElementForm" novalidate>
                <div class="form-grid">
                    <!-- Basic Info Group -->
                    <div class="form-group">
                        <h3>Basic Information</h3>
                        
                        <div class="input-group">
                            <label for="elementName">Name*</label>
                            <input type="text" id="elementName" name="elementName" placeholder="Enter element name">
                        </div>
                        
                        <div class="input-group">
                            <label for="elementCategory">Category</label>
                            <select id="elementCategory" name="elementCategory" onchange="WorldBuilding.handleDropdownChange('elementCategory', this.value)">
                                <option value="">Select Category</option>
                                <!-- Options will be populated by WorldBuilding.initializeWorldElementForm() -->
                            </select>
                            <div id="newElementCategoryForm" class="new-item-form">
                                <input type="text" id="newElementCategoryInput" placeholder="Enter new category">
                                <div class="form-buttons-row">
                                    <button type="button" onclick="WorldBuilding.addNewItem('elementCategory')">Add Category</button>
                                    <button type="button" onclick="WorldBuilding.cancelNewItem('elementCategory')" class="cancel-btn">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="elementSeries">Series</label>
                            <select id="elementSeries" name="elementSeries">
                                <option value="">Select Series</option>
                                <!-- Options will be populated by WorldBuilding.initializeWorldElementForm() -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- Related Elements -->
                    <div class="form-group">
                        <h3>Related Elements</h3>
                        
                        <div class="input-group">
                            <label for="relatedElements">Related Elements</label>
                            <select id="relatedElements" name="relatedElements" multiple size="5">
                                <!-- Options will be populated by WorldBuilding.initializeWorldElementForm() -->
                            </select>
                            <small>Hold Ctrl/Cmd to select multiple</small>
                        </div>
                        
                        <!-- Tags -->
                        <div class="input-group">
                            <label>Tags</label>
                            <div id="worldElementTagSelector" class="tag-selector" data-entity-type="worldElement" data-entity-id="">
                                <!-- Tag selector will be populated by Tags.createTagSelector() -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="form-group">
                        <h3>Description</h3>
                        
                        <div class="input-group">
                            <label for="elementDescription">Description</label>
                            <!-- Rich Text Editor Toolbar -->
                            <div class="rich-text-toolbar">
                                <button type="button" class="rich-text-btn" data-command="bold" title="Bold">B</button>
                                <button type="button" class="rich-text-btn" data-command="italic" title="Italic">I</button>
                                <button type="button" class="rich-text-btn" data-command="underline" title="Underline">U</button>
                                <button type="button" class="rich-text-btn" data-command="insertUnorderedList" title="Bullet List">• List</button>
                                <button type="button" class="rich-text-btn" data-command="insertOrderedList" title="Numbered List">1. List</button>
                            </div>
                            <div id="worldElementRichTextEditor" class="rich-text-editor" contenteditable="true"></div>
                            <textarea id="elementDescription" name="elementDescription" style="display: none;"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="add-element-btn"><i class="fas fa-plus-circle"></i> Add</button>
                    <button type="button" class="clear-form-btn" onclick="WorldBuilding.clearWorldElementForm()"><i class="fas fa-eraser"></i> Clear</button>
                </div>
            </form>
            
            <!-- World Element Table -->
            <div class="table-container">
                <table id="worldElementTable">
                    <thead>
                        <tr>
                            <th onclick="WorldBuilding.sortWorldElementTable('name')" class="sortable">Name</th>
                            <th onclick="WorldBuilding.sortWorldElementTable('category')" class="sortable">Category</th>
                            <th onclick="WorldBuilding.sortWorldElementTable('series')" class="sortable">Series</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="worldElementList"></tbody>
                </table>
                <div id="worldbuildingPagination" class="pagination-controls"></div>
            </div>
        </div>
        
        <!-- Timeline Tab -->
        <div id="timeline-tab" class="tab-content">
            <h2>Story Timeline</h2>
            
            <div class="search-container">
                <select id="timelineFilterSeries">
                    <option value="all">All Series</option>
                </select>
                <select id="timelineFilterBook">
                    <option value="all">All Books</option>
                </select>
                <select id="timelineFilterCharacter">
                    <option value="all">All Characters</option>
                </select>
                <button id="applyTimelineFilters" class="apply-filters-btn">Apply Filters</button>
            </div>
            
            <div class="timeline-container">
                <div class="timeline-line"></div>
                <div id="timelineContent"></div>
            </div>
        </div>
        
        <!-- Statistics Tab -->
        <div id="statistics-tab" class="tab-content">
            <!-- Content will be dynamically generated by Statistics.createStatisticsDashboard() -->
        </div>
        
        <!-- Analyze Book Tab -->
        <div id="analyze-book-tab" class="tab-content">
            <h2>Book Analysis</h2>
            
            <div class="book-analysis-container">
                <!-- Analysis Options Section -->
                <div class="analysis-options" style="width: calc(100% + 10px); height: 450px; overflow-y: auto;">
                    <h3>Analysis Options</h3>
                    <div style="position: relative; width: 100%;">
                        <button type="button" id="readmeBtn" class="primary-btn" onclick="BookAnalysis.showReadme()" style="position: absolute; top: -52px; right: 0;">
                            <i class="fas fa-question-circle"></i> Read Me
                        </button>
                    </div>
                    <div class="option-group" style="position: relative; left: 10px;">
                        <label for="minMentions">Minimum Character Mentions:</label>
                        <div style="display: flex; align-items: center;">
                            <input type="number" id="minMentions" min="1" value="3" class="form-control" style="width: 60px; text-align: center;">
                            <span style="margin-left: 10px;">Only show characters mentioned at least this many times</span>
                        </div>
                    </div>

                    <!-- Analysis Options Checkboxes -->
                    <div class="option-group" style="margin-top: 15px;">
                        <div style="display: flex; margin-bottom: 15px;">
                            <div style="width: 66.67%; text-align: center; font-weight: bold;">Detection Methods</div>
                            <div style="width: 33.33%; text-align: center; font-weight: bold;">Additional Options</div>
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                            <!-- Detection Methods Container -->
                            <div style="flex: 2; min-width: 400px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <!-- Column 1 -->
                                    <div class="checkbox-wrapper" style="display: flex; flex-direction: column; gap: 10px;">
                                        <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                            <div style="width: 24px; display: flex; justify-content: center;">
                                                <input type="checkbox" id="dialogueAttribution" checked>
                                            </div>
                                            <label for="dialogueAttribution" style="margin-left: 10px; cursor: pointer;">Dialogue Attribution</label>
                                        </div>
                                        
                                        <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                            <div style="width: 24px; display: flex; justify-content: center;">
                                                <input type="checkbox" id="namedEntityRecognition">
                                            </div>
                                            <label for="namedEntityRecognition" style="margin-left: 10px; cursor: pointer;">Named Entity Recognition</label>
                                        </div>
                                        
                                        <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                            <div style="width: 24px; display: flex; justify-content: center;">
                                                <input type="checkbox" id="capitalizedWordAnalysis">
                                            </div>
                                            <label for="capitalizedWordAnalysis" style="margin-left: 10px; cursor: pointer;">Capitalized Word Analysis</label>
                                        </div>
                                        
                                        <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                            <div style="width: 24px; display: flex; justify-content: center;">
                                                <input type="checkbox" id="frequencyAnalysis2" checked>
                                            </div>
                                            <label for="frequencyAnalysis2" style="margin-left: 10px; cursor: pointer;">Frequency Analysis</label>
                                        </div>
                                    </div>

                                    <!-- Column 2 -->
                                    <div class="checkbox-wrapper" style="display: flex; flex-direction: column; gap: 10px;">
                                        <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                            <div style="width: 24px; display: flex; justify-content: center;">
                                                <input type="checkbox" id="titleHonorificDetection">
                                            </div>
                                            <label for="titleHonorificDetection" style="margin-left: 10px; cursor: pointer;">Title & Honorific Detection</label>
                                        </div>
                                        
                                        <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                            <div style="width: 24px; display: flex; justify-content: center;">
                                                <input type="checkbox" id="directAddressPattern">
                                            </div>
                                            <label for="directAddressPattern" style="margin-left: 10px; cursor: pointer;">Direct Address Pattern</label>
                                        </div>
                                        
                                        <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                            <div style="width: 24px; display: flex; justify-content: center;">
                                                <input type="checkbox" id="possessiveFormDetection">
                                            </div>
                                            <label for="possessiveFormDetection" style="margin-left: 10px; cursor: pointer;">Possessive Form Detection</label>
                                        </div>
                                        
                                        <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                            <div style="width: 24px; display: flex; justify-content: center;">
                                                <input type="checkbox" id="characterIntroduction">
                                            </div>
                                            <label for="characterIntroduction" style="margin-left: 10px; cursor: pointer;">Character Introduction</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Additional Options Column -->
                            <div style="flex: 1; min-width: 200px;">
                                <div class="checkbox-wrapper" style="display: flex; flex-direction: column; gap: 10px;">
                                    <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                        <div style="width: 24px; display: flex; justify-content: center;">
                                            <input type="checkbox" id="combineVariants">
                                        </div>
                                        <label for="combineVariants" style="margin-left: 10px; cursor: pointer;">Combine name variants</label>
                                    </div>
                                    
                                    <div class="checkbox-option" style="display: flex; align-items: center; background: #2d2d2d; color: white; padding: 10px 15px; border-radius: 8px;">
                                        <div style="width: 24px; display: flex; justify-content: center;">
                                            <input type="checkbox" id="filterCommonWords">
                                        </div>
                                        <label for="filterCommonWords" style="margin-left: 10px; cursor: pointer;">Filter common words</label>
                                    </div>
                                </div>
                                
                                <div class="detection-method-warning" style="font-size: 0.8rem; color: #e74c3c; font-weight: normal; margin-top: 20px; text-align: center;">
                                    Requires at least one detection method
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Book Upload Section -->
                <div class="book-upload-section" style="width: calc(100% - 75px); margin-left: 75px;">
                    <h3>Upload Book</h3>
                    
                    <div id="fileDropArea" class="file-drop-area" style="height: 150px; padding: 15px; margin-bottom: 15px; border: 2px dashed #3498db; border-radius: 8px; background-color: white;">
                        <div class="drop-area-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div class="drop-icon-container" style="margin-bottom: 10px;">
                                <i class="fas fa-cloud-upload-alt drop-icon" style="font-size: 1.5rem; color: #3498db;"></i>
                                <span class="file-msg" style="font-size: 0.9rem; color: #333; font-weight: bold; display: block; margin-top: 5px;">Drag & drop your book file here</span>
                            </div>
                            <span class="fake-btn" id="chooseFilesBtn" style="background-color: #3498db; color: white; padding: 6px 12px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; margin: 10px 0;">Choose Files</span>
                            <input type="file" id="bookFileUpload" class="file-input" accept=".txt,.docx,.rtf,.html,.htm" style="position: absolute; width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; z-index: -1;">
                            <span class="file-msg" style="font-size: 0.8rem; color: #555; font-weight: bold; display: block; margin-top: 5px;">Supported: TXT, DOCX, RTF, HTML</span>
                        </div>
                    </div>
                    
                    <div style="height: 25px;">
                        <!-- Spacer to push buttons down -->
                    </div>
                    
                    <div class="action-buttons" style="margin-bottom: 15px; display: flex; justify-content: center; gap: 10px;">
                        <button type="button" id="analyzeBookBtn" class="primary-btn" style="min-width: 120px;">
                            <i class="fas fa-chart-bar"></i> Analyze Book
                        </button>
                        <button type="button" id="clearAnalysisBtn" class="secondary-btn" onclick="BookAnalysis.clearAnalysis()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                    
                    <div id="uploadedFiles" class="uploaded-files" style="height: 60px; overflow-y: auto;">
                        <!-- Uploaded files will be displayed here -->
                    </div>
            </div>
            
            <!-- Analysis Results Section -->
            <div class="analysis-results-container">
                <!-- Loading Indicator -->
                <div id="analysisLoading" class="loading-indicator" style="display: none;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%;">
                        <button id="cancelAnalysisBtn" class="cancel-btn" style="background-color: #e74c3c; color: white; border: none; border-radius: 4px; padding: 8px 16px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">Cancel</button>
                        <div class="progress-container" style="flex-grow: 1;">
                            <div class="progress-bar-container">
                                <div id="analysisProgressBar" class="progress-bar"></div>
                            </div>
                            <div id="analysisProgressText" class="progress-text">Processing...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Format Info -->
                <div id="formatInfo" class="format-info" style="display: none;">
                    <!-- File format info will be displayed here -->
                </div>
                
                <!-- Analysis Results -->
                <div id="analysisResults" style="display: none;">
                    <div class="results-header">
                        <div class="results-title">
                            <h3>Character Analysis Results</h3>
                            <!-- Removed the three report buttons as requested -->
                        </div>
                        <div id="seriesBookSection" class="series-book-section" style="display: none; align-items: flex-start; gap: 20px; margin-right: 20px; margin-top: 15px;">
                            <!-- Table action buttons -->
                            <div class="table-actions" style="display: flex; flex-direction: column; gap: 10px;">
                                <button id="addToTableBtn" class="primary-btn" onclick="BookAnalysis.addToTable()">
                                    <i class="fas fa-table"></i> Add to Table
                                </button>
                                <button id="clearTableBtn" class="secondary-btn" onclick="BookAnalysis.clearTable()">
                                    <i class="fas fa-eraser"></i> Clear Table
                                </button>
                            </div>
                            <!-- Series and Book container -->
                            <div class="series-book-container" style="display: flex; flex-direction: row; gap: 20px;">
                                <div class="input-group" style="margin-bottom: 0; min-width: 250px;">
                                    <label for="analysisSeries">Series:</label>
                                    <select id="analysisSeries" name="analysisSeries" onchange="BookAnalysis.handleDropdownChange('analysisSeries', this.value)">
                                        <option value="">Select Series</option>
                                        <option value="new">+ Add New Series</option>
                                        <!-- Will be populated dynamically -->
                                    </select>
                                    <div id="newAnalysisSeriesForm" class="new-item-form">
                                        <input type="text" id="newAnalysisSeriesInput" placeholder="Enter new series">
                                        <div class="form-buttons-row">
                                            <button type="button" onclick="BookAnalysis.addNewItem('analysisSeries')">Add Series</button>
                                            <button type="button" onclick="BookAnalysis.cancelNewItem('analysisSeries')" class="cancel-btn">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="input-group" style="margin-bottom: 0; min-width: 250px;">
                                    <label for="analysisBook">Book:</label>
                                    <select id="analysisBook" name="analysisBook" onchange="BookAnalysis.handleDropdownChange('analysisBook', this.value)">
                                        <option value="">Select Book</option>
                                        <option value="new">+ Add New Book</option>
                                        <!-- Will be populated dynamically -->
                                    </select>
                                    <div id="newAnalysisBookForm" class="new-item-form">
                                        <input type="text" id="newAnalysisBookInput" placeholder="Enter new book">
                                        <div class="form-buttons-row">
                                            <button type="button" onclick="BookAnalysis.addNewItem('analysisBook')">Add Book</button>
                                            <button type="button" onclick="BookAnalysis.cancelNewItem('analysisBook')" class="cancel-btn">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="results-content">
                        <div id="tableActionButtons" class="result-actions" style="display: none;">
                            <button class="select-all-btn" onclick="BookAnalysis.selectAllCharacters()" style="min-width: 150px; padding: 8px 16px;">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                            <button class="deselect-all-btn" onclick="BookAnalysis.deselectAllCharacters()" style="min-width: 150px; padding: 8px 16px;">
                                <i class="fas fa-square"></i> Deselect All
                            </button>
                            <button class="add-selected-btn" onclick="BookAnalysis.addSelectedCharacters()" style="min-width: 220px; padding: 8px 16px;">
                                <i class="fas fa-user-plus"></i> Add Selected to Database
                            </button>
                        </div>
                        </div>
                        
                        <div id="detectedCharacters">
                            <!-- Detected characters will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rich Text Editor Enhancement Script -->
    <script src="js/rich-text-editor.js"></script>
    
    <!-- Database Delete Fix Script -->
    <script src="js/database-delete-fix.js"></script>

    <!-- End of Scripts -->
    <script src="js/header-text-align-fix.js"></script>
</body>
</html>
